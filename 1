pipeline {
    agent any

    environment {
        GIT_CREDENTIALS = 'github-ssh'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout([$class: 'GitSCM', 
                    branches: [[name: 'main']],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [],
                    userRemoteConfigs: [[url: 'https://github.com/mgseixas91/gitops-k8s.git', credentialsId: "${GIT_CREDENTIALS}"]]
                ])
            }
        }

        stage('Definir quantidade de novos ambientes') {
            steps {
                script {
                    // Input para definir a quantidade de novos ambientes
                    QTD_AMBIENTES = input(
                        id: 'userInput', message: 'Quantidade de novos ambientes a criar', parameters: [[$class: 'StringParameterDefinition', defaultValue: '1', description: '', name: 'Quantidade']]
                    ).toInteger()
                    echo "Quantidade de novos ambientes a criar: ${QTD_AMBIENTES}"
                }
            }
        }

        stage('Preparar ambientes') {
            steps {
                script {
                    // Descobrir namespaces existentes
                    EXISTENTES = sh(script: "kubectl get ns --no-headers -o custom-columns=:metadata.name | grep ^tst || true", returnStdout: true).trim().split("\n")
                    if(EXISTENTES[0] == '') { EXISTENTES = [] }
                    echo "Ambientes existentes: ${EXISTENTES}"

                    // Criar lista de novos ambientes a criar
                    AMBIENTES_A_CRIAR = []
                    for(int i=EXISTENTES.size(); i<EXISTENTES.size()+QTD_AMBIENTES; i++) {
                        AMBIENTES_A_CRIAR.add("tst${i}")
                    }
                    echo "Novos ambientes a criar: ${AMBIENTES_A_CRIAR}"

                    TODOS_AMBIENTES = AMBIENTES_A_CRIAR
                    echo "Todos ambientes para certs e secrets: ${TODOS_AMBIENTES}"
                }
            }
        }

        stage('Verificar scripts') {
            steps {
                sh '''
                    chmod +x gitops-envs/scripts/*.sh
                    ls -l gitops-apps/apps
                '''
            }
        }

        stage('Gerar san.cnf dinamicamente') {
            steps {
                script {
                    TODOS_AMBIENTES.each { ns ->
                        def sanFile = "certs/san-${ns}.cnf"
                        writeFile file: sanFile, text: "# Conteúdo do SAN para ${ns}\n"
                        echo "Arquivo san.cnf gerado: ${sanFile}"
                    }
                }
            }
        }

        stage('Criar ambientes e certificados') {
            steps {
                script {
                    TODOS_AMBIENTES.each { ns ->
                        echo "Criando/validando ambiente ${ns}"

                        // Criar namespace se não existir
                        def nsExist = sh(script: "kubectl get ns ${ns} || true", returnStatus: true)
                        if(nsExist != 0) {
                            sh "kubectl create ns ${ns}"
                        }

                        // Reutilizar secret do ACR
                        sh """
                            kubectl get secret acr-secret -n acr -o yaml | \
                            sed 's/namespace: acr/namespace: ${ns}/' | \
                            kubectl apply -f -
                        """

                        // Gerar certificados (mantendo como antes)
                        sh "gitops-envs/scripts/create_certs.sh ${ns} certs/san-${ns}.cnf certs/"
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline finalizada'
        }
        failure {
            echo 'Ocorreu um erro durante a execução da pipeline'
        }
    }
}

